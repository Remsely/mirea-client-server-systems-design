@startuml
!include <C4/C4_Context>

Person(Клиент, "Клиент", "Представитель компании-клиента. Получает запросы и загружает документы.")
Person(Бухгалтер, "Бухгалтер", "Сотрудник. Создаёт запросы документов, отслеживает статус загрузки в интерфейсе, загружает документы самостоятельно.")
Person(SRE, "SRE-инженер", "Сотрудник. Следит за состоянием оркестратора процессов, исправляет инциденты.")

System_Boundary(Система, "Система запроса документов по бухгалтерским операциям") {
  System(BackendCore, "Backend (Core)", "Ядро системы запроса документов: бизнес-логика, интеграции с внешними системами. Предоставляет API и поддержку передачи файлов.")
  System(BackendBPM, "Backend (BPM)", "Оркестратор процессов сервиса запроса документов. Управляет жизненным циклом процессов сбора документов.")
  System(BackendAccounting, "Backend бухгалтерии", "Сервисы бухгалтерии, обеспечивающие взаимодействие с бухгалтерскими процессами и внедрение в них сервиса сбора документов.")
  System(WebAppClient, "Веб-приложение клиента", "Интерфейс для Клиента в браузере. Позволяет просматривать запросы и загружать документы.")
  System(WebAppAccounting, "Веб-приложение бухгалтера", "Интерфейс для Бухгалтера в браузере. Позволяет создавать и управлять сборами документов, просматривать их статусы, загружать и скачивать файлы.")
  System(MobileApp, "Мобильное приложение", "Мобильный клиент. Позволяет клиентам просматривать запросы и загружать документы.")
}

System_Ext(SSO, "Система клиентской авторизации SSO", "OAuth2 / ролевой доступ для пользователей.")
System_Ext(MSA, "Система межсервисной авторизации", "OAuth2 Client Credentials / межсервисная аутентификация.")
System_Ext(DocStorage, "Хранилище документов", "Хранение файлов и их метаданных.")
System_Ext(Verification, "Система верификации документов", "Проверка формата документов и их соответствия запрошенным типам.")
System_Ext(Notifications, "Система нотификации", "Сервис для уведомления клиентов и бухгалтеров.")
System_Ext(DWH, "Хранилище данных DWH", "Приём и хранение данных для аналитики.")
System_Ext(AdminPanel, "Панель оркестратора процессов", "UI для мониторинга и управления процессами BPM.")

' --- Взаимодействие пользователей с приложениями ---
Rel(Клиент, WebAppClient, "Просмотр запросов документов, загрузка файлов", "HTTPS")
Rel(Клиент, MobileApp, "Просмотр запросов документов, загрузка файлов", "HTTPS")
Rel(Бухгалтер, WebAppAccounting, "Создание сборов документов и их мониторинг; загрузка/скачивание файлов", "HTTPS")

' --- Фронтенды и бэкенды ---
Rel(WebAppClient, BackendCore, "Вызов API: передача файлов", "REST/HTTPS")
Rel(WebAppClient, BackendAccounting, "Вызов API: получение данных об активных сборах документов", "REST/HTTPS")
Rel(MobileApp, BackendCore, "Вызов API: передача файлов", "REST/HTTPS")
Rel(MobileApp, BackendAccounting, "Вызов API: получение данных об активных сборах документов", "REST/HTTPS")

Rel(WebAppAccounting, BackendAccounting, "Вызов API: управление сборами документов, передача файлов", "REST/HTTPS")

' --- Авторизация между сервисами (SSO и MSA) ---
Rel(BackendCore, SSO, "Валидация пользовательских токенов, получение ролевых данных", "HTTPS/OAuth2")
Rel(BackendAccounting, SSO, "Валидация пользовательских токенов, получение ролевых данных", "HTTPS/OAuth2")

Rel(BackendCore, MSA, "Получение токена для межсервисной аутентификации", "HTTPS/OAuth2")
Rel(BackendAccounting, MSA, "Получение токена для межсервисной аутентификации", "HTTPS/OAuth2")
Rel(BackendBPM, MSA, "Получение токена для межсервисной аутентификации", "HTTPS/OAuth2")

' --- Интеграции с внешними системами ---
Rel(BackendCore, DocStorage, "Загрузка/получение файлов, сохранение метаданных", "REST/HTTPS")
Rel(BackendCore, Verification, "Отправка документов на верификацию, получение результата", "REST/HTTPS")
Rel(BackendCore, Notifications, "Запрос на отправку уведомлений", "REST/HTTPS")
Rel(Notifications, Клиент, "Доставка уведомлений клиенту", "Push/Email/SMS")
Rel(Notifications, Бухгалтер, "Доставка уведомлений бухгалтеру", "Push/Email/SMS")
Rel(BackendCore, DWH, "Передача данных для аналитики", "Binary/HTTPS")

' --- Оркестрация процессов (Core -> BPM, односторонняя) ---
Rel(BackendCore, BackendBPM, "Инициализация процессов, управление очередями", "REST/HTTPS")

' --- Админская панель ---
Rel(SRE, AdminPanel, "Мониторинг и управление процессами", "HTTPS/UI (через SSO)")
Rel(AdminPanel, BackendBPM, "Получение данных о процессах", "REST/HTTPS")

' --- Односторонняя связь между Backend бухгалтерии и Core ---
Rel(BackendAccounting, BackendCore, "Вызов API: получение данных о сборах документов", "REST/HTTPS; multipart/form-data")

@enduml
